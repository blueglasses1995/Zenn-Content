---
title: "NestJSãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«"
emoji: "ğŸ™†"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

```sh
npm i -g @nestjs/cli
nest new nest-only
code nest-only
```

http://localhost:3000/ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨`Hello World!`ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```sh
npm run start:dev
```

```ts:main.ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  await app.listen(3000);
}
bootstrap();
```

NestJSã¯ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’èµ·ç‚¹ã¨ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚°ãƒ©ãƒ•ã‚’çµ„ã¿ç«‹ã¦ã‚‹ã€‚
ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚°ãƒ©ãƒ•ã¨ã¯ã€NestJSãŒãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ä¾å­˜é–¢ä¿‚ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®å†…éƒ¨çš„ãªãƒ‡ãƒ¼ã‚¿ã§ã‚ã‚‹ã€‚
importsã«ã¯ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å†…ã§å¿…è¦ãªãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«`ã‚’æŒ‡å®šã™ã‚‹ã€‚
exportsã«ã¯ã“ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒæä¾›ã—ã¦ã„ã¦ã€ã‹ã¤ä»–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒå‚ç…§ã—ãŸã„`ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼` (or ãƒ¬ã‚¢ã‚±ãƒ¼ã‚¹ã¨ã—ã¦)`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«`ã‚’æŒ‡å®šã™ã‚‹ã€‚

```ts:app.module.ts
@Module({
  imports: [],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

é‡è¦ãªã®ã¯ã€importsã«ç›´æ¥`ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼`ã‚„`ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼`ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ããªã„ã“ã¨ã§ã‚ã‚‹ã€‚
```sh
Classes annotated with @Injectable(), @Catch(), and @Controller() decorators must not appear in the "imports" array of a module.
```

```ts:app.controller.ts
@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }
}
```

```ts:app.service.ts
@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello World!';
  }
}
```

æ–‡è¨€ã‚’å¤‰ãˆã¦ã¿ã‚‹ã€‚
ãƒ–ãƒ©ã‚¦ã‚¶ã§å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨æ–‡è¨€ãŒå¤‰ã‚ã£ã¦è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```ts:app.service.ts
@Injectable()
export class AppService {
  getHello(): string {
    return 'Hello!';
  }
}
```

ãƒ‘ã‚¹ã‚’å¤‰æ›´ã™ã‚‹ã€‚

```ts:app.controller.ts
@Controller('hello')
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  getHello(): string {
    return this.appService.getHello();
  }
}
```

http://localhost:3000/ã§ã¯ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```json
{"message":"Cannot GET /","error":"Not Found","statusCode":404}
```

http://localhost:3000/helloã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```
hello!
```

ä»¥ä¸‹ã§ã‚‚åŒæ§˜ã®ãƒ‘ã‚¹ã§è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```ts:app.controller.ts
@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get('hello')
  getHello(): string {
    return this.appService.getHello();
  }
}
```

```ts:app.service.ts
  getGoodNight(): string {
    return 'Good Night!';
  }
```

```ts:app.service.ts
@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get('hello')
  getHello(): string {
    return this.appService.getHello();
  }

  @Get('good-night')
  getGoodNight(): string {
    return this.appService.getGoodNight();
  }
}
```

http://localhost:3000/good-nightã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä»¥ä¸‹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```
Good Night!
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã¨http://localhost:3000/good-nightã§ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
http://localhost:3000/greeting/good-nightã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```ts:app.service.ts
@Controller('greeting)
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get('hello')
  getHello(): string {
    return this.appService.getHello();
  }

  @Get('good-night')
  getGoodNight(): string {
    return this.appService.getGoodNight();
  }
}
```

controllerã®ãƒ¡ã‚½ãƒƒãƒ‰åã¯ãªã‚“ã§ã‚‚è‰¯ã„ã€‚
Getãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã¯Nestã«ç›´å¾Œã®ãƒ¡ã‚½ãƒƒãƒ‰ãŒã€ŒHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç‰¹å®šã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã€ã§ã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹ã€‚
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆGetãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãªã‚‰GETãƒ¡ã‚½ãƒƒãƒ‰ï¼‰ã¨ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã®çµ„ã¿åˆã‚ã›ã€‚
ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã¯Controllerãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ãƒ‘ã‚¹ã¨Getãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®ãƒ‘ã‚¹ã‚’çµåˆã—ãŸæ–‡å­—åˆ—ã€‚ï¼ˆä»Šå›ã§ã„ã†ã¨/greeting/good-nightï¼‰
ã“ã®Controllerã¯`Get /greeting/hello`ã¨`Get /greeting/good-night`ã®2ã¤ã®ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã«å¯¾å¿œã™ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å¯¾å¿œã¥ã‘ã‚‹ã€‚

```ts:app.service.ts
@Controller('greeting')
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get('hello')
  getHello(): string {
    return this.appService.getHello();
  }

  @Get('good-night')
  hoge(): string {
    return this.appService.getGoodNight();
  }
}
```

Reqãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã§NestJSã«å¯¾ã—ã¦ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯expressï¼‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®ä¾å­˜ã‚’æ³¨å…¥ã•ã›ã‚‹ã“ã¨ãŒã§ãã‚‹
å¿…ãšãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä»‹ã—ã¦ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ä¾å­˜ã®ãƒªã‚½ãƒ¼ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã‚‹ã“ã¨ã§ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’å®¹æ˜“ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
http://localhost:3000/greeting/good-morning
```ts:app.controller.ts
  @Get('good-morning')
  getGoodMorning(@Req() req: Request): string {
    return `Good Morning from ${req.url}`;
  }
```

http://localhost:3000/greeting/echo?greeting=hello!ã§hello!ãŒè¿”ã£ã¦ãã‚‹ã€‚

```ts:app.controller.ts
  @Get('echo')
  echo(@Query('greeting') query: string): string {
    console.log({ query });
    return query;
  }
```

```ts:app.controller.ts
  @Post()
  greet(): string {
    return 'hi!';
  }
```

expressæµã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç”¨ã„ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ã“ã¨ãŒã§ãã‚‹ã€‚
NestJSã¯éæ¨å¥¨ã¨ã—ã¦ã„ã‚‹ã€‚
http://localhost:3000/greeting/good-evening
```ts:app.controller.ts
  @Get('good-evening')
  getGoodEvening(@Res() res: Response): void {
    res.status(200).send('good evening!');
  }
```

ãƒ¯ã‚¤ãƒ«ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€http://localhost:3000/greeting/good_eveningã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
```ts:app.controller.ts
  @Get('good*evening')
  getGoodEvening(@Res() res: Response): void {
    res.status(200).send('good evening!');
  }
```

http://localhost:3000/greeting/partial-contentã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨GoodãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
Networkã‚¿ãƒ–ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰: 206ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã€‚

```ts:app.controller.ts
  @Get('partial-content')
  @HttpCode(206)
  getPartialContent(): string {
    return 'Good';
  }
```

ä¸Šè¨˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã§ã¯Cache-ControlãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„ã€‚
Headerãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–ã‚Šå‡ºã™ã“ã¨ãªãCache-Controlã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```ts:app.controller.ts
  @Get('partial-content')
  @Header('Cache-Control', 'none')
  @HttpCode(206)
  getPartialContent(): string {
    return 'Good';
  }
```

http://localhost:3000/greetingã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ã€‚
```ts:app.controllers.ts
  @Get()
  @Redirect('https://nestjs.com', 301)
  default(): void {}
```

http://localhost:3000/greeting/translate/jaã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ™‚ã«ã€Œã“ã‚“ã«ã¡ã¯ã€ã€
http://localhost:3000/greeting/translate/esã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸæ™‚ã«ã€Œhola!ã€ã‚’è¡¨ç¤ºã—ãŸã„ã€‚
```ts:app.service.ts
  @Get('translate/:lang')
  translate(@Param('lang') lang: string): string {
    switch (lang) {
      case 'ja':
        return 'ã“ã‚“ã«ã¡ã¯';
      case 'es':
        return 'hola!';
      default:
        return 'I do not understand it';
    }
  }
```

promiseã‚’è¿”ã—ã¦ã‚‚ã€NestJSãŒè§£æ±ºã™ã‚‹ã®ã‚’å¾…ã£ã¦ã‹ã‚‰ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¦ãã‚Œã‚‹ã€‚
http://localhost:3000/greeting/promiseã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€å°‘ã—çµŒã£ã¦ã‹ã‚‰promiseãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

```ts:app.controller.ts
  @Get('promise')
  getPromise(): Promise<string> {
    return new Promise((resolve) => {
      setTimeout(() => {
        resolve('promise');
      }, 1000);
    });
  }
```

```sh
nest g co book
```

controllersã«BookControllerãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

```ts:app.module.ts
@Module({
  imports: [],
  controllers: [AppController, BookController],
  providers: [AppService],
})
```

http://localhost:3000/bookã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨`all books selected`
http://localhost:3000/book/100ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨`The book of id 100 selected`ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã€‚

```ts:book/book.controllers.ts
@Controller('book')
export class BookController {
  @Get(':id')
  get(@Param('id') id: string): string {
    return `The book of id ${id} selected`;
  }

  @Get()
  getAll(): string {
    return 'all books selected';
  }

  @Post(':id')
  create(@Param('id') id: string): string {
    return `the book of id ${id} created`;
  }

  @Put(':id')
  update(@Param('id') id: string): string {
    return `the book of id ${id} updated`;
  }

  @Delete(':id')
  delete(@Param('id') id: string): string {
    return `the book of id ${id} deleted`;
  }
}
```

ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‹ã‚‰BookControllerã‚’å¤–ã—ã¦åŒç”»é¢ã«å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨`Not Found`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚
```ts:app.module.ts
@Module({
  imports: [],
  controllers: [AppController],
  providers: [AppService],
})
```

Bookå°‚ç”¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ä½œã‚Šã€ä¾å­˜é–¢ä¿‚ã‚’ä»»ã›ã‚‹ã€‚
```sh
nest g mo book
```

ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯BookControllerã®å­˜åœ¨ã‚’çŸ¥ã‚‰ãšã€BookModuleã®å­˜åœ¨ã®ã¿çŸ¥ã£ã¦ã„ã‚‹ã€‚
```ts:app.module.ts
@Module({
  imports: [BookModule],
  controllers: [AppController],
  providers: [AppService],
})
```

BookModuleã«BookControllerã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯BookModuleçµŒç”±ã§BookControllerã®å­˜åœ¨ã‚’çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
```ts:book:module.ts
@Module({
  controllers: [BookController],
})
export class BookModule {}
```

DTOã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹ã€‚
```ts:book/book.dto.ts
export class CreateBookDto {
  title: string;
  author: string;
}

export class UpdateBookDto {
  title: string;
  author: string;
  isInSale: boolean;
}
```

```ts:book.service.ts
  @Post(':id')
  create(@Param('id') id: string, @Body() body: CreateBookDto): string {
    return `the book of id ${id} created: ${body.title} by ${body.author}`;
  }

  @Put(':id')
  update(@Param('id') id: string, @Body() body: UpdateBookDto): string {
    return `the book of id ${id} updated: ${body.title} by ${body.author} ${body.isInSale ? 'in sale' : 'out of sale'}`;
  }
```

ã‚µãƒ¼ãƒ“ã‚¹ã€ãƒªãƒã‚¸ãƒˆãƒªã€ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ã€ãƒ˜ãƒ«ãƒ‘ãƒ¼ã‚’ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ã—ã¦å®Ÿè£…ã—ã€NestJSã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ãŒãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä¾å­˜ã¨ã—ã¦æ³¨å…¥ã™ã‚‹ä½œæ¥­ã‚’è¡Œã†ã€‚
ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¯ãƒ—ãƒ¬ãƒ¼ãƒ³ã¯JSã‚¯ãƒ©ã‚¹ã§ã€ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã§providersé…åˆ—ã¨ã—ã¦å®£è¨€ã•ã‚Œã‚‹ã€‚

```sh
nest g s book
```

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã®ã‚„ã‚Šã¨ã‚Šã‚’ä¸€ä»»ã—ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã¯ãƒ­ã‚¸ãƒƒã‚¯ã«é›†ä¸­ã§ãã‚‹ã€‚
```ts:book/book.service.ts
@Injectable()
export class BookService {
  get(id: string) {
    return `The book of id ${id} selected`;
  }

  getAll() {
    return 'all books selected';
  }

  create(id: string, body: CreateBookDto) {
    return `the book of id ${id} created: ${body.title} by ${body.author}`;
  }

  update(id: string, body: UpdateBookDto) {
    return `the book of id ${id} updated: ${body.title} by ${body.author} ${body.isInSale ? 'in sale' : 'out of sale'}`;
  }

  delete(id: string) {
    return `the book of id ${id} deleted`;
  }
}
```

```ts:book/book.controller.ts
@Controller('book')
export class BookController {
  constructor(private readonly bookService: BookService) {}

  @Get(':id')
  get(@Param('id') id: string): string {
    return this.bookService.get(id);
  }

  @Get()
  getAll(): string {
    return this.bookService.getAll();
  }

  @Post(':id')
  create(@Param('id') id: string, @Body() body: CreateBookDto): string {
    return this.bookService.create(id, body);
  }

  @Put(':id')
  update(@Param('id') id: string, @Body() body: UpdateBookDto): string {
    return this.bookService.update(id, body);
  }

  @Delete(':id')
  delete(@Param('id') id: string): string {
    return this.bookService.delete(id);
  }
}
```

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚ˆã‚Šå‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚

```ts:logger.middleware.ts
import { Injectable } from '@nestjs/common';
import { NextFunction, Request, Response } from 'express';

@Injectable()
export class LoggerMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('Request...', req.url);
    next();
  }
}
```

BookModuleã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’è¨­å®šã™ã‚‹ãŒã€AppModuleã«ã¯è¨­å®šã—ãªã„ã€‚
http://localhost:3000/book/100ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãƒ­ã‚°ãŒã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤ºã•ã‚Œã‚‹ã€‚
http://localhost:3000/greeting/helloã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„ã€‚
```ts:book.module.ts
@Module({
  controllers: [BookController],
  providers: [BookService],
})
export class BookModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(LoggerMiddleware).forRoutes(BookController);
  }
}
```

é–¢æ•°ã¨ã—ã¦middlewareã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
```ts:loggerFunction.middleware.ts
export const loggerFunctionMiddleware = (
  req: Request,
  res: Response,
  next: NextFunction,
) => {
  console.log('Params...', req.params);
  next();
};
```

middlewareã‚’è¤‡æ•°æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
```ts:book/book.middleware.ts
configure(consumer: MiddlewareConsumer) {
    consumer
      .apply(LoggerMiddleware, loggerFunctionMiddleware)
      .forRoutes(BookController);
```


# ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

NestJSã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚°ãƒ­ãƒ¼ãƒãƒ«ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãŒå­˜åœ¨ã—ã¦ã„ã¦ã€HttpExceptionã‚¯ãƒ©ã‚¹ã®ä¾‹å¤–ã‚’é€å‡ºã™ã‚‹å½¹å‰²ã‚’æ‹…ã£ã¦ã„ã‚‹ã€‚
ãã‚Œä»¥å¤–ã®ä¾‹å¤–ã«ã¤ã„ã¦ã¯å…¨ã¦ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ã‚’åãã€‚
```json
{
  "statusCode": 500,
  "message": "Internal server error"
}
```

```ts:app.controller.ts
  @Get('error')
  getError(): string {
    throw new HttpException('I am a teapot', HttpStatus.I_AM_A_TEAPOT);
  }
```

http://localhost:3000/greeting/errorã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```json
{"statusCode":418,"message":"I am a teapot"}
```

NestJSã¯HTTPExceptionã‚’ç¶™æ‰¿ã—ãŸãƒ“ãƒ«ãƒˆã‚¤ãƒ³ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’æä¾›ã—ã¦ã„ã‚‹ã€‚
```ts:app.controller.ts
  @Get('error')
  getError(): string {
    // throw new HttpException('I am a teapot', HttpStatus.I_AM_A_TEAPOT);
    throw new ImATeapotException();
  }
```

ã‚«ã‚¹ã‚¿ãƒ ä¾‹å¤–ã‚¯ãƒ©ã‚¹ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
```ts:book/NoBookFoundException.ts
export class NoBookFoundException extends HttpException {
  constructor() {
    super('No book found', 404);
  }
}
```

http://localhost:3000/book/100ã§No book foundã®ã‚¨ãƒ©ãƒ¼ãŒã§ã‚‹ã€‚
http://localhost:3000/book/99ãŒå‡ºãªã„ã€‚
```ts:book/book.controller.ts
  @Get(':id')
  get(@Param('id') id: string): string {
    if (Number(id) >= 100) {
      throw new NoBookFoundException();
    }
    return this.bookService.get(id);
  }
```

```ts:book/bookException.ts
@Catch(NoBookFoundException)
export class BookExceptionFilter {
  catch(exception: NoBookFoundException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const request = ctx.getRequest();
    const response = ctx.getResponse();
    const status = exception.getStatus();

    console.log('No book found');

    response.status(status).json({
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
    });
  }
}
```

ä¸Šè¨˜ã ã‘ã§ã¯http://localhost:3000/book/100ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ãŒå‡ºãªã„ã€‚
controllerã«ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ç™»éŒ²ã—ã¦ã‚ã’ãªã„ã¨ã„ã‘ãªã„ã€‚

```ts:book/book.controller.ts
  @Get(':id')
  @UseFilters(new BookExceptionFilter())
  get(@Param('id') id: string): string {
    if (Number(id) >= 100) {
      throw new NoBookFoundException();
    }
    return this.bookService.get(id);
  }
```

ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå¤‰ã‚ã£ã¦ã„ã‚‹ã€‚
ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚`No book found`ãƒ­ã‚°ãŒå‡ºã¦ã„ã‚‹ã€‚
```json
{"statusCode":404,"timestamp":"2024-10-08T05:24:20.371Z","path":"/book/100"}
```

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å…¨ä½“ã«ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’åŠ¹ã‹ã›ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã€‚
```ts:book/book.controller.ts

@Controller('book')
@UseFilters(BookExceptionFilter)
export class BookController {
```

ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã€id=100, id=200ã®æœ¬ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚
å‰è€…ã§ã¯`No book found`ãƒ­ã‚°ãŒå‡ºã‚‹ãŒã€å¾Œè€…ã§ã¯å‡ºãªã„ã€‚
ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼`BookExceptionFilter`ã¯Catchãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§æŒ‡å®šã—ãŸ`NoBookFoundException`ã®ã¿ã‚’æ‹¾ã„ãƒ­ã‚°ã‚’å‡ºã—ã€`HttpException`ã¯æ‹¾ã‚ãªã„ã“ã¨ãŒã‚ã‹ã‚‹ã€‚

```ts:book/book.controller.ts
  @Get(':id')
  @UseFilters(BookExceptionFilter)
  get(@Param('id') id: string): string {
    if (Number(id) >= 200) {
      throw new HttpException('Too many books to search', 404);
    }
    if (Number(id) >= 100) {
      throw new NoBookFoundException();
    }
    return this.bookService.get(id);
  }
```

# ãƒ‘ã‚¤ãƒ—

ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã®ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã«å¯¾ã—ã¦ãƒ‘ã‚¤ãƒ—ã‚’ç´ä»˜ã‘ã¦ç”¨ã„ã‚‹ã€‚
ãƒ‘ã‚¤ãƒ—ã¯ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚ˆã‚Šã‚‚å‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚
ãƒ‘ã‚¤ãƒ—ã¯ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¾ãŸã¯ç½®æ›ã«åˆ©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒå¤šã„ã€‚

BookControllerã®getãƒ¡ã‚½ãƒƒãƒ‰ã§ã¯ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¯idã‚’Numberå‹ã§æ‰±ã„ãŸã„ã®ã§ãƒ‘ã‚¤ãƒ—ã‚’ç”¨ã„ã¦äº‹å‰ã«ç½®æ›ã—ã¦ã‚ã’ã‚‹ã€‚
ParseIntPipeã¯NestJSãƒ“ãƒ«ãƒˆã‚¤ãƒ³ã®ãƒ‘ã‚¤ãƒ—ã€‚

```ts:book/book.controller.ts
  @Get(':id')
  @UseFilters(BookExceptionFilter)
  get(@Param('id', ParseIntPipe) id: number): string {
    if (id >= 200) {
      throw new HttpException('Too many books to search', 404);
    }
    if (id >= 100) {
      throw new NoBookFoundException();
    }
    return this.bookService.get(id);
  }
```

```ts:book/book.service.ts
  get(id: number) {
    return `The book of id ${id} selected`;
  }
```

idéƒ¨åˆ†ã«æ•°å€¤ã«å¤‰æ›ã§ããªã„æ–‡å­—åˆ—ã‚’æ¸¡ã™ã¨é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
http://localhost:3000/book/100i
```json
{"message":"Validation failed (numeric string is expected)","error":"Bad Request","statusCode":400}
```

ãƒ‘ã‚¤ãƒ—ã‚’è‡ªå‰ã§ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã—ã€ãã®å¼•æ•°ã«è¨­å®šã‚’åŠ ãˆã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ä¸€ä¾‹ã¨ã—ã¦ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹ã€‚
```ts:book/book.controller.ts
  @Get(':id')
  @UseFilters(BookExceptionFilter)
  get(
    @Param(
      'id',
      new ParseIntPipe({ errorHttpStatusCode: HttpStatus.NOT_ACCEPTABLE }),
    )
    id: number,
  ): string {
    if (id >= 200) {
      throw new HttpException('Too many books to search', 404);
    }
    if (id >= 100) {
      throw new NoBookFoundException();
    }
    return this.bookService.get(id);
  }
```

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãŒ406ã«å¤‰ã‚ã£ã¦ã„ã‚‹ã€‚
```json
{"message":"Validation failed (numeric string is expected)","error":"Not Acceptable","statusCode":406}
```

ãƒ‘ã‚¤ãƒ—ã‚’è‡ªä½œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
PipeTransformã®å‹å¼•æ•°ã«å¤‰æ›å‰ã®å‹ã¨å¤‰æ›å¾Œã®å‹ã‚’æ˜è¨˜ã™ã‚‹ã€‚

```ts:book/BookIdValidator.pipe.ts
@Injectable()
export class BookIdValidator implements PipeTransform<string, number> {
  transform(value: string, metadata: ArgumentMetadata) {
    const id = Number(value);
    if (isNaN(id)) throw new HttpException('The id is not a number', 404);
    return id;
  }
}
```

```ts:book.controller.ts
  @Get(':id')
  @UseFilters(BookExceptionFilter)
  get(
    @Param('id', BookIdValidator)
    id: number,
  ): string {
    ...
```

ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«è¨˜è¿°ã—ã¦ã„ãŸæ¡ä»¶åˆ†å²ã‚’ãƒ‘ã‚¤ãƒ—ã«ç§»å‹•ã™ã‚‹ã€‚

```ts:book/BookIdValidator.pipe.ts
@Injectable()
export class BookIdValidator implements PipeTransform<string, number> {
  transform(value: string, metadata: ArgumentMetadata) {
    const id = Number(value);
    if (isNaN(id)) throw new HttpException('The id is not a number', 404);
    if (id >= 200) {
      throw new HttpException('Too many books to search', 404);
    }
    if (id >= 100) {
      throw new NoBookFoundException();
    }
    return id;
  }
}
```

å˜ä¸€è²¬ä»»åŸå‰‡ã«å‰‡ã‚Šãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‹ã‚‰ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ‡ã‚Šé›¢ã™ã“ã¨ãŒã§ãã‚‹ã€‚
ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã‚‚Requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’èª­ã‚€ã“ã¨ã§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ã—ã‹ã—ã€ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ãƒ‘ã‚¤ãƒ—ã¨ç•°ãªã‚Šå®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’èªçŸ¥ã›ãšã€ã€Œã©ã®ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å‰ã«å‘¼ã³å‡ºã•ã‚ŒãŸã‹ã€ãŒã‚ã‹ã‚‰ãªã„ã€‚
ã¾ãŸã€Requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã®å€¤ã®å–ã‚Šå‡ºã—ãŒå‘½ä»¤çš„ã«ãªã‚‹ã€‚
ãƒ‘ã‚¤ãƒ—ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã‚ˆã‚Šæ±ç”¨çš„ã§å®£è¨€çš„ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ã§ãã‚‹ã€‚

```ts:book/book.controller.ts
  @Get(':id')
  @UseFilters(BookExceptionFilter)
  get(
    @Param('id', BookIdValidator)
    id: number,
  ): string {
    return this.bookService.get(id);
  }
```

å…¨ã¦ã®ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã«ç°¡æ½”ã«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é©ç”¨ã§ãã‚‹ã€‚

```ts:book/book.controller.ts
@Controller('book')
export class BookController {
  constructor(private readonly bookService: BookService) {}

  @Get(':id')
  @UseFilters(BookExceptionFilter)
  get(
    @Param('id', BookIdValidator)
    id: number,
  ): string {
    return this.bookService.get(id);
  }

  @Get()
  getAll(): string {
    return this.bookService.getAll();
  }

  @Post(':id')
  create(
    @Param('id', BookIdValidator) id: number,
    @Body() body: CreateBookDto,
  ): string {
    return this.bookService.create(id, body);
  }

  @Put(':id')
  update(
    @Param('id', BookIdValidator) id: number,
    @Body() body: UpdateBookDto,
  ): string {
    return this.bookService.update(id, body);
  }

  @Delete(':id')
  delete(@Param('id', BookIdValidator) id: number): string {
    return this.bookService.delete(id);
  }
}
```

```ts:book/book.service.ts
@Injectable()
export class BookService {
  get(id: number) {
    return `The book of id ${id} selected`;
  }

  getAll() {
    return 'all books selected';
  }

  create(id: number, body: CreateBookDto) {
    return `the book of id ${id} created: ${body.title} by ${body.author}`;
  }

  update(id: number, body: UpdateBookDto) {
    return `the book of id ${id} updated: ${body.title} by ${body.author} ${body.isInSale ? 'in sale' : 'out of sale'}`;
  }

  delete(id: number) {
    return `the book of id ${id} deleted`;
  }
}
```

ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ã‚’ã‚ˆã‚Šå®£è¨€çš„ã«ã™ã‚‹ãŸã‚ã«ã¯è¤‡æ•°ã®æ–¹æ³•ãŒã‚ã‚‹ã€‚
ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ã‚­ãƒ¼ãƒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: Zod
ã‚¯ãƒ©ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: class-validator

ä»Šå›ã¯zodã‚’åˆ©ç”¨ã™ã‚‹ã€‚

```sh
npm install --save zod
```

zodã®ã‚¹ã‚­ãƒ¼ãƒã‚’æœ€å¤§é™æ´»ç”¨ã™ã‚‹ãŸã‚ã«Nullãƒã‚§ãƒƒã‚¯ã‚’å³æ ¼ã«è¨­å®šã™ã‚‹ã€‚
```json:tsconfig.json
"strictNullChecks": true,
```

æ±ç”¨çš„ãªZodã«ã‚ˆã‚‹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãŸã‚ã®ãƒ‘ã‚¤ãƒ—ã‚’ç”¨æ„ã™ã‚‹ã€‚
å‘¼ã³å‡ºã—å…ƒãŒschemaã‚’ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆæ™‚ã«Zodã‚¹ã‚­ãƒ¼ãƒã‚’æ¸¡ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

```ts:ZodValidator.pipe.ts
import { ArgumentMetadata, PipeTransform } from '@nestjs/common';
import { ZodSchema } from 'zod';

export class ZodValidator implements PipeTransform {
  constructor(private schema: ZodSchema) {}

  transform(value: unknown, metadata: ArgumentMetadata) {
    try {
      return this.schema.parse(value);
    } catch (_: unknown) {
      throw new Error('Validation failed');
    }
  }
}
```

ã‚¹ã‚­ãƒ¼ãƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å®šç¾©ã™ã‚‹ã€‚
ã‚¹ã‚­ãƒ¼ãƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰DTOã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
book/book.dto.tsãŒä¸è¦ã«ãªã‚‹ãŸã‚å‰Šé™¤ã™ã‚‹ã€‚

```ts:book/book.schema.ts
import { z } from 'zod';

export const CreateBookSchema = z.object({
  title: z.string().min(3).max(30),
  author: z.string().min(3).max(255),
});

export const UpdateBookSchema = z.object({
  title: z.string().min(3).max(30),
  author: z.string().min(3).max(255),
  isInSale: z.boolean(),
});

export type CreateBookDto = z.infer<typeof CreateBookSchema>;
export type UpdateBookDto = z.infer<typeof UpdateBookSchema>;
```

```ts:book/book.controller.ts
import { ZodValidatorPipe } from 'src/ZodValidator.pipe';
import {
  CreateBookDto,
  CreateBookSchema,
  UpdateBookDto,
  UpdateBookSchema,
} from './book.schema';
...
  @Post(':id')
  @UsePipes(new ZodValidatorPipe(CreateBookSchema))
  @UseFilters(BookExceptionFilter)
  create(
    @Param('id', BookIdValidator) id: number,
    @Body() body: CreateBookDto,
  ): string {
    return this.bookService.create(id, body);
  }

  @Put(':id')
  @UsePipes(new ZodValidatorPipe(UpdateBookSchema))
  update(
    @Param('id', BookIdValidator) id: number,
    @Body() body: UpdateBookDto,
  ): string {
    return this.bookService.update(id, body);
  }
```

ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹ã®DTOã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‚’å¤‰æ›´ã™ã‚‹ã€‚

```ts:book/book.service.ts
import { CreateBookDto, UpdateBookDto } from './book.schema';
```

# ã‚¬ãƒ¼ãƒ‰

ã‚¬ãƒ¼ãƒ‰ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚
ã‚¬ãƒ¼ãƒ‰ã¯è¨˜è¿°ã—ãŸæ¡ä»¶ã«åŸºã¥ã„ã¦æ¬¡ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’å‘¼ã³å‡ºã™ã‹å¦ã‹ã®åˆ¤å®šã‚’ã™ã‚‹ã€‚
expressã§ã¯ä¼çµ±çš„ã«ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒèªè¨¼ãƒ»èªå¯ã®åˆ¤å®šã‚’è¡Œã£ã¦ã„ãŸã€‚
ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’èªçŸ¥ã›ãšã€Œæ¬¡ã«ã©ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ãŒå‘¼ã°ã‚Œã‚‹ã‹ã€ã‚’çŸ¥ã‚‰ãªã„ãŒã€ã‚¬ãƒ¼ãƒ‰ã¯çŸ¥ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ã‚¬ãƒ¼ãƒ‰ã¯å…¨ã¦ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ãŒé€šéã—ãŸå¾Œã€ã‹ã¤ãƒ‘ã‚¤ãƒ—ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã‚ˆã‚Šå‰ã«å‘¼ã³å‡ºã•ã‚Œã‚‹ã€‚

ä¾‹ã¨ã—ã¦getãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã€ãã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã‚¬ãƒ¼ãƒ‰ã‚’å®Ÿè£…ã™ã‚‹ã€‚

```ts:Auth.guard.ts
@Injectable()
export class AuthGuard implements CanActivate {
  canActivate(
    ctx: ExecutionContext,
  ): boolean | Promise<boolean> | Observable<boolean> {
    const handlerName = ctx.getHandler().name;
    console.log({ handlerName });
    return handlerName === 'get';
  }
}
```

get, getAllä¸¡æ–¹ã«ã‚¬ãƒ¼ãƒ‰ã‚’ä»˜ä¸ã™ã‚‹ã€‚
http://localhost:3000/book/100ã«ã¯å¼•ãç¶šãã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚

```ts:book/book.controller.ts
  @Get(':id')
  @UseFilters(BookExceptionFilter)
  @UseGuards(AuthGuard)
  get(
    @Param('id', BookIdValidator)
    id: number,
  ): string {
    return this.bookService.get(id);
  }

  @Get()
  @UseGuards(AuthGuard)
  getAll(): string {
    return this.bookService.getAll();
  }
```

ã—ã‹ã—http://localhost:3000/bookã«ã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã€ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚
```json
{"message":"Forbidden resource","error":"Forbidden","statusCode":403}
```

å®Ÿè¡Œã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰ãƒ¡ã‚½ãƒƒãƒ‰åã‚’å–ã‚Šå‡ºã—ã€ãƒ¡ã‚½ãƒƒãƒ‰åã‚’å…ƒã«ã‚¢ã‚¯ã‚»ã‚¹ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè£…ã§ããŸã€‚
ã—ã‹ã—ã‚ˆã‚Šå®£è¨€çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ãŸã„ã€‚

```ts:Roles.decorators.ts
import { Reflector } from '@nestjs/core';

export const Roles = Reflector.createDecorator<string[]>();
```

Rolesã‚«ã‚¹ã‚¿ãƒ ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’åˆ©ç”¨ã™ã‚‹ã€‚

```ts:book/book.controller.ts
  @Get(':id')
  @UseFilters(BookExceptionFilter)
  @UseGuards(AuthGuard)
  @Roles(['admin', 'user'])
  get(
    @Param('id', BookIdValidator)
    id: number,
  ): string {
    return this.bookService.get(id);
  }

  @Get()
  @UseGuards(AuthGuard)
  @Roles(['admin'])
  getAll(): string {
    return this.bookService.getAll();
  }
```

useræ¨©é™ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹getãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã§ãã‚‹ã€‚
http://localhost:3000/bookã«ã¯å¼•ãç¶šãã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„ã€‚

```ts:Auth.guard.ts
@Injectable()
export class AuthGuard implements CanActivate {
  constructor(private readonly reflector: Reflector) {}

  canActivate(
    ctx: ExecutionContext,
  ): boolean | Promise<boolean> | Observable<boolean> {
    const roles = this.reflector.get(Roles, ctx.getHandler());

    console.log({ roles });
    return roles.includes('user');
  }
}
```

# ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼

ã‚¢ã‚¹ãƒšã‚¯ãƒˆæŒ‡å‘ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€‚
ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼å†…éƒ¨ã§å‘¼ã³å‡ºã™ã“ã¨ã§ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼å‰å¾Œã«å‡¦ç†ã‚’è¿½åŠ ã™ã‚‹ã€‚

```ts:logger.interceptor.ts
import { CallHandler, ExecutionContext, NestInterceptor } from '@nestjs/common';
import { Observable, tap } from 'rxjs';

export class LoggerInterceptor implements NestInterceptor {
  intercept(
    context: ExecutionContext,
    next: CallHandler<any>,
  ): Observable<any> | Promise<Observable<any>> {
    console.log('Before...');
    const now = Date.now();
    return next
      .handle()
      .pipe(tap(() => console.log(`After... ${Date.now() - now}ms`)));
  }
}
```

ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®configureãƒ¡ã‚½ãƒƒãƒ‰ã§ç™»éŒ²ã™ã‚‹ãŒã€ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼ã¯ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã«UseInterceptorãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ç™»éŒ²ã§ãã‚‹ã€‚
```ts:book/book.controller.ts
@UseInterceptors(LoggingInterceptor)
```

- http://localhost:3000/book
  - LoggerMiddlewareãŒãƒ­ã‚°`Request...`ã‚’åã
  - AuthGuardãŒä¾‹å¤–ã‚’åã
  - ãƒ­ã‚°`Before...`ãŒè¡¨ç¤ºã•ã‚Œãªã„
  - ãƒ­ã‚°`After...`ãŒè¡¨ç¤ºã•ã‚Œãªã„
- http://localhost:3000/book/100
- LoggerMiddlewareãŒãƒ­ã‚°`Request...`ã‚’åã
  - BookIdValidatorãŒä¾‹å¤–ã‚’åã
  - ãƒ­ã‚°`Before...`ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  - ãƒ­ã‚°`After...`ãŒè¡¨ç¤ºã•ã‚Œãªã„
- http://localhost:3000/book/99
  - LoggerMiddlewareãŒãƒ­ã‚°`Request...`ã‚’åã
  - å‡¦ç†ã«æˆåŠŸã™ã‚‹
  - ãƒ­ã‚°`Before...`ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  - ãƒ­ã‚°`After...`ãŒè¡¨ç¤ºã•ã‚Œã‚‹

ä¸Šè¨˜ã‚ˆã‚Šã€ä»¥ä¸‹ãŒã‚ã‹ã‚‹ã€‚
- ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢(è¤‡æ•°) -> ã‚¬ãƒ¼ãƒ‰ -> ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼(handleä»¥å‰) -> ãƒ‘ã‚¤ãƒ— -> ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ -> ã‚¤ãƒ³ã‚¿ãƒ¼ã‚»ãƒ—ã‚¿ãƒ¼(handleä»¥å¾Œ)
- ä¾‹å¤–ãŒåã‹ã‚Œã‚‹ã¨ä»¥é™ã®å‡¦ç†ã«å±Šã‹ãšã€ä¾‹å¤–ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«åˆ°é”ã™ã‚‹ã€‚
  
ãƒ­ã‚°ã¯handleãƒ¡ã‚½ãƒƒãƒ‰ã®å¾Œã®å‡¦ç†ã¯handleãƒ¡ã‚½ãƒƒãƒ‰ã§ä¾‹å¤–ãŒé€å‡ºã•ã‚ŒãŸå ´åˆã«ã¯åˆ°é”ã—ãªã„ã“ã¨ã«æ³¨æ„ãŒå¿…è¦ã€‚

```ts:timeout.interceptor.ts
import {
  CallHandler,
  ExecutionContext,
  NestInterceptor,
  RequestTimeoutException,
} from '@nestjs/common';
import {
  catchError,
  Observable,
  throwError,
  timeout,
  TimeoutError,
} from 'rxjs';

export class TimeoutInterceptor implements NestInterceptor {
  intercept(
    context: ExecutionContext,
    next: CallHandler<any>,
  ): Observable<any> | Promise<Observable<any>> {
    return next.handle().pipe(
      timeout(5000),
      catchError((err) => {
        if (err instanceof TimeoutError) {
          return throwError(() => new RequestTimeoutException());
        }
        return throwError(() => err);
      }),
    );
  }
}
```

```ts:book/book.controller.ts
@UseInterceptors(LoggerInterceptor, TimeoutInterceptor)
```

# å‹•çš„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
# ApolloServerã‚’åˆ©ç”¨ã—GraphQLåŒ–
# NestJS, ApolloServer, Prismaã§GraphQL APIã‚’å®Ÿè£…
# TSã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã®æ©Ÿèƒ½ã‚’ç†è§£
